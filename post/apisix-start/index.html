<!doctype html><html lang=zh-cn dir=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=content-security-policy content="upgrade-insecure-requests"><title>APISIX源码-启动过程 - 幸福和富有的过一生</title><meta name=keywords content="云计算,软件开发,架构师,思考,读书,笔记,技术,投资,加密货币,区块链"><meta name=author content="lizj3624"><meta property="og:title" content="APISIX源码-启动过程"><meta property="og:site_name" content="幸福和富有的过一生"><meta property="og:image" content="/img/author.jpg"><meta name=title content="APISIX源码-启动过程 - 幸福和富有的过一生"><meta name=description content="欢迎来到我的空间站，个人主要专注于软件开发，科技技术，云计算，加密货币。"><link rel="shortcut icon" href=/img/favicon.ico><link rel=apple-touch-icon href=/img/apple-touch-icon.png><link rel=apple-touch-icon-precomposed href=/img/apple-touch-icon.png><link href=//unpkg.com/font-awesome@4.7.0/css/font-awesome.min.css rel=stylesheet type=text/css><link href=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.css rel=stylesheet><link href=/css/main.css rel=stylesheet type=text/css><link href=/css/syntax.css rel=stylesheet type=text/css></head><body itemscope itemtype=http://schema.org/WebPage lang=zh-Hans><div class="container one-collumn sidebar-position-left page-home"><div class=headband></div><header id=header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle role=button style=opacity:1;top:0><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><div class=custom-logo-site-title><a href=/ class=brand rel=start><span class=logo-line-before><i></i></span>
<span class=site-title>幸福和富有的过一生</span>
<span class=logo-line-after><i></i></span></a></div><p class=site-subtitle>幸福和富有的过一生!</p></div><div class=site-nav-right><div class="toggle popup-trigger" style=opacity:1;top:0><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul id=menu class=menu><li class=menu-item><a href=/ rel=section><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-active"><a href=/post rel=section><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class=menu-item><a href=/about.html rel=section><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于我</a></li><li class=menu-item><a href=/404.html rel=section><i class="menu-item-icon fa fa-fw fa-heartbeat"></i><br>公益404</a></li><li class="menu-item menu-item-search"><a href=javascript:; class=popup-trigger><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class=site-search><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class=search-icon><i class="fa fa-search"></i></span>
<span class=popup-btn-close><i class="fa fa-times-circle"></i></span><div class=local-search-input-wrapper><input autocomplete=off placeholder=搜索关键字... spellcheck=false type=text id=local-search-input autocapitalize=none autocorrect=off></div></div><div id=local-search-result></div></div></div></nav></div></header><main id=main class=main><div class=main-inner><div class=content-wrap><div id=content class=content><section id=posts class=posts-expand><article class="post post-type-normal" itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline"><a class=post-title-link href=/post/apisix-start/ itemprop=url>APISIX源码-启动过程</a></h1><div class=post-meta><span class=post-pushdate><i class="fa fa-calendar-o fa-fw"></i>
<span class=post-meta-item-text>时间：</span>
<time itemprop=dateCreated datetime=2016-03-22T13:04:35+08:00 content="2022-04-03">2022-04-03</time></span>
<span class=post-category><i class="fa fa-folder-o fa-fw"></i>
<span class=post-meta-item-text>分类：</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a class=post-category-a href=/categories/apisix itemprop=url rel=index><span itemprop=name>apisix</span></a>
&nbsp;</span>
<span itemprop=about itemscope itemtype=https://schema.org/Thing><a class=post-category-a href=/categories/nginx itemprop=url rel=index><span itemprop=name>nginx</span></a>
&nbsp;</span></span>
<span class=post-wordcount><i class="fa fa-file-word-o fa-fw"></i>
<span class=post-meta-item-text>字数：</span>
<span class=leancloud-world-count>2737 字</span></span>
<span class=post-readtime><i class="fa fa-eye fa-fw"></i>
<span class=post-meta-item-text>阅读：</span>
<span class=leancloud-view-count>6分钟</span></span>
<span id=/post/apisix-start/ class="leancloud_visitors post-visitor" data-flag-title=APISIX源码-启动过程><i class="fa fa-binoculars fa-fw"></i>
<span class=post-meta-item-text>阅读次数：</span>
<span class=leancloud-visitors-count></span></span></div></header><div class=post-body itemprop=articleBody><h2 id=apisix启动命令>apisix启动命令</h2><p>APISIX<a href=https://github.com/apache/apisix/blob/master/docs/en/latest/how-to-build.md target=_blank rel=noopener>安装</a>
之后，开始启动APISIX，APISIX写一套启动命令工具。
执行<code>apisix help</code>可以查看命令详细信息:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ apisix <span style=color:#a2f>help</span>
</span></span><span style=display:flex><span>/usr/local/openresty/luajit/bin/luajit /usr/local/apisix/apisix/cli/apisix.lua <span style=color:#a2f>help</span>
</span></span><span style=display:flex><span>Usage: apisix <span style=color:#666>[</span>action<span style=color:#666>]</span> &lt;argument&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>help:       show this message, <span style=color:#a2f;font-weight:700>then</span> <span style=color:#a2f>exit</span>
</span></span><span style=display:flex><span>init:       initialize the <span style=color:#a2f>local</span> nginx.conf
</span></span><span style=display:flex><span>init_etcd:  initialize the data of etcd
</span></span><span style=display:flex><span>start:      start the apisix server
</span></span><span style=display:flex><span>stop:       stop the apisix server
</span></span><span style=display:flex><span>quit:       stop the apisix server gracefully
</span></span><span style=display:flex><span>restart:    restart the apisix server
</span></span><span style=display:flex><span>reload:     reload the apisix server
</span></span><span style=display:flex><span>version:    print the version of apisix
</span></span></code></pre></div><h2 id=启动源码简析>启动源码简析</h2><h3 id=启动流程>启动流程</h3><p><img src=./start-flow.png alt=01></p><blockquote><p>如果OpenResty版本不是1.19，就通过lua启动apisix.lua</p></blockquote><h3 id=源码分析>源码分析</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>$ tree -L <span style=color:#666>2</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── apisix
</span></span><span style=display:flex><span>│   ├── admin
</span></span><span style=display:flex><span>│   ├── api_router.lua
</span></span><span style=display:flex><span>│   ├── balancer
</span></span><span style=display:flex><span>│   ├── balancer.lua
</span></span><span style=display:flex><span>│   ├── cli
</span></span><span style=display:flex><span>│   ├── constants.lua
</span></span><span style=display:flex><span>│   ├── consumer.lua
</span></span><span style=display:flex><span>│   ├── control
</span></span><span style=display:flex><span>│   ├── core
</span></span><span style=display:flex><span>│   ├── core.lua
</span></span><span style=display:flex><span>│   ├── debug.lua
</span></span><span style=display:flex><span>│   ├── discovery
</span></span><span style=display:flex><span>│   ├── error_handling.lua
</span></span><span style=display:flex><span>│   ├── http
</span></span><span style=display:flex><span>│   ├── init.lua
</span></span><span style=display:flex><span>│   ├── patch.lua
</span></span><span style=display:flex><span>│   ├── plugin_config.lua
</span></span><span style=display:flex><span>│   ├── plugin.lua
</span></span><span style=display:flex><span>│   ├── plugins
</span></span><span style=display:flex><span>│   ├── router.lua
</span></span><span style=display:flex><span>│   ├── schema_def.lua
</span></span><span style=display:flex><span>│   ├── script.lua
</span></span><span style=display:flex><span>│   ├── ssl
</span></span><span style=display:flex><span>│   ├── ssl.lua
</span></span><span style=display:flex><span>│   ├── stream
</span></span><span style=display:flex><span>│   ├── timers.lua
</span></span><span style=display:flex><span>│   ├── upstream.lua
</span></span><span style=display:flex><span>│   ├── utils
</span></span><span style=display:flex><span>│   └── wasm.lua
</span></span><span style=display:flex><span>├── bin
</span></span><span style=display:flex><span>│   └── apisix
</span></span><span style=display:flex><span>├── CHANGELOG.md
</span></span><span style=display:flex><span>├── CODE_OF_CONDUCT.md
</span></span><span style=display:flex><span>├── CODE_STYLE.md
</span></span><span style=display:flex><span>├── conf
</span></span><span style=display:flex><span>│   ├── apisix.yaml
</span></span><span style=display:flex><span>│   ├── cert
</span></span><span style=display:flex><span>│   ├── config-default.yaml
</span></span><span style=display:flex><span>│   ├── config.yaml
</span></span><span style=display:flex><span>│   ├── debug.yaml
</span></span><span style=display:flex><span>│   ├── mime.types
</span></span><span style=display:flex><span>│   └── nginx.conf
</span></span><span style=display:flex><span>├── CONTRIBUTING.md
</span></span><span style=display:flex><span>├── deps
</span></span><span style=display:flex><span>│   ├── lib
</span></span><span style=display:flex><span>│   └── share
</span></span><span style=display:flex><span>├── LICENSE
</span></span><span style=display:flex><span>├── MAINTAIN.md
</span></span><span style=display:flex><span>├── Makefile
</span></span><span style=display:flex><span>├── NOTICE
</span></span><span style=display:flex><span>├── powered-by.md
</span></span><span style=display:flex><span>├── README.md
</span></span><span style=display:flex><span>└── rockspec
</span></span><span style=display:flex><span>    ├── apisix-2.12.1-0.rockspec
</span></span><span style=display:flex><span>    └── apisix-master-0.rockspec
</span></span></code></pre></div><p>apisix源码<code>bin/apisix</code>是命令入口，是一个<code>shell</code>脚本，通过<code>lua</code>或<code>luajit</code>启动apisix编写的启动lua脚本，这些lua脚步主要在<code>apisix/cli</code>目录下。
<code>apisix.lua</code>中引用的<code>lua</code>包路径，解析参数，执行相应命令参数的回调函数，启动apisix。命令行中每个参数对应一个回调函数，这些函数在<code>ops.lua</code>中。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>local</span> action <span style=color:#666>=</span> {
</span></span><span style=display:flex><span>    help <span style=color:#666>=</span> help,
</span></span><span style=display:flex><span>    version <span style=color:#666>=</span> version,
</span></span><span style=display:flex><span>    init <span style=color:#666>=</span> init,
</span></span><span style=display:flex><span>    init_etcd <span style=color:#666>=</span> etcd.init,
</span></span><span style=display:flex><span>    start <span style=color:#666>=</span> start,
</span></span><span style=display:flex><span>    stop <span style=color:#666>=</span> stop,
</span></span><span style=display:flex><span>    quit <span style=color:#666>=</span> quit,
</span></span><span style=display:flex><span>    restart <span style=color:#666>=</span> restart,
</span></span><span style=display:flex><span>    reload <span style=color:#666>=</span> reload,
</span></span><span style=display:flex><span>    test <span style=color:#666>=</span> test,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>function</span> <span style=color:#00f>_M</span>.<span style=color:#00a000>execute</span>(env, arg)
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>local</span> cmd_action <span style=color:#666>=</span> arg[<span style=color:#666>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#a2f;font-weight:700>not</span> cmd_action <span style=color:#a2f;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> help()
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#a2f;font-weight:700>not</span> action[cmd_action] <span style=color:#a2f;font-weight:700>then</span>
</span></span><span style=display:flex><span>        stderr:write(<span style=color:#b44>&#34;invalid argument: &#34;</span>, cmd_action, <span style=color:#b44>&#34;</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#b44>&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a2f;font-weight:700>return</span> help()
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    action[cmd_action](env, arg[<span style=color:#666>2</span>])
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>end</span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>我看一下<code>start</code>函数</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#a2f;font-weight:700>local</span> <span style=color:#a2f;font-weight:700>function</span> <span style=color:#00a000>start</span>(env, ...)
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>-- 创建日志目录</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>local</span> cmd_logs <span style=color:#666>=</span> <span style=color:#b44>&#34;mkdir -p &#34;</span> <span style=color:#666>..</span> env.apisix_home <span style=color:#666>..</span> <span style=color:#b44>&#34;/logs&#34;</span>
</span></span><span style=display:flex><span>    util.execute_cmd(cmd_logs)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>-- 检查是否已经启动</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>-- 解析命令行参数</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>local</span> parser <span style=color:#666>=</span> argparse()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>-- 解析用户自定义配置参数</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>-- 初始化</span>
</span></span><span style=display:flex><span>    init(env)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>-- 初始化etcd</span>
</span></span><span style=display:flex><span>    init_etcd(env, args)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>-- 执行启动OpenResty命令</span>
</span></span><span style=display:flex><span>    util.execute_cmd(env.openresty_args)
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>end</span>
</span></span></code></pre></div><p>这个启动函数中最重要的是<code>init(env)</code>初始化函数，这里初始化了apisix启动所有的配置信息，根据配置参数以及模板生成<code>nginx.conf</code>配置。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span><span style=color:#a2f;font-weight:700>local</span> <span style=color:#a2f;font-weight:700>function</span> <span style=color:#00a000>init</span>(env)
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>-- 判断root path， apisix不推荐在root下启动apisix</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>-- 检查 ulimit，建议将ulimit设置大一些</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>-- 解析conf/*.yaml的配置</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>local</span> yaml_conf, err <span style=color:#666>=</span> file.read_yaml_conf(env.apisix_home)
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#a2f;font-weight:700>not</span> yaml_conf <span style=color:#a2f;font-weight:700>then</span>
</span></span><span style=display:flex><span>        util.die(<span style=color:#b44>&#34;failed to read local yaml config of apisix: &#34;</span>, err, <span style=color:#b44>&#34;</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#b44>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>-- 校验解析yaml是否正确，因为需要根据yaml配置信息，生成nginx.conf，这个配置很重要，因此apisix在这里进行大量的校验</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#080;font-style:italic>-- 校验成功后，生成nginx.conf配置</span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>local</span> conf_render <span style=color:#666>=</span> template.compile(ngx_tpl)
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>local</span> ngxconf <span style=color:#666>=</span> conf_render(sys_conf)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>local</span> ok, err <span style=color:#666>=</span> util.write_file(env.apisix_home <span style=color:#666>..</span> <span style=color:#b44>&#34;/conf/nginx.conf&#34;</span>,
</span></span><span style=display:flex><span>                                    ngxconf)
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>if</span> <span style=color:#a2f;font-weight:700>not</span> ok <span style=color:#a2f;font-weight:700>then</span>
</span></span><span style=display:flex><span>        util.die(<span style=color:#b44>&#34;failed to update nginx.conf: &#34;</span>, err, <span style=color:#b44>&#34;</span><span style=color:#b62;font-weight:700>\n</span><span style=color:#b44>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a2f;font-weight:700>end</span>
</span></span><span style=display:flex><span><span style=color:#a2f;font-weight:700>end</span>
</span></span></code></pre></div><p>apisix的生成<code>nginx.conf</code>的<a href=https://github.com/apache/apisix/blob/master/apisix/cli/ngx_tpl.lua target=_blank rel=noopener>模板</a>
，<code>nginx.conf</code>不能手工修改，应该它
每次启动时会重新生成，apisix也是支持自定义配置的，<a href=https://apisix.apache.org/zh/docs/apisix/customize-nginx-configuration target=_blank rel=noopener>自定义配置</a>
。
看一下渲染生成的<code>nginx.conf</code>配置，我这个没有设置4层(stream)的配置，apisix也是支持4层转发的。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># Configuration File - Nginx Server Configs
</span></span><span style=display:flex><span># This is a read-only file, do not try to modify it.
</span></span><span style=display:flex><span>master_process on;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>worker_processes auto;
</span></span><span style=display:flex><span>worker_cpu_affinity auto;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># main configuration snippet starts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># main configuration snippet ends
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>error_log logs/error.log warn;
</span></span><span style=display:flex><span>pid logs/nginx.pid;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>worker_rlimit_nofile 20480;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>events {
</span></span><span style=display:flex><span>    accept_mutex off;
</span></span><span style=display:flex><span>    worker_connections 10620;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>worker_rlimit_core  16G;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>worker_shutdown_timeout 240s;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>env APISIX_PROFILE;
</span></span><span style=display:flex><span>env PATH; # for searching external plugin runner&#39;s binary
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>http {
</span></span><span style=display:flex><span>    # put extra_lua_path in front of the builtin path
</span></span><span style=display:flex><span>    # so user can override the source code
</span></span><span style=display:flex><span>    lua_package_path  &#34;$prefix/deps/share/lua/5.1/?.lua;$prefix/deps/share/lua/5.1/?/init.lua;/usr/local/apisix/?.lua;/usr/local/apisix/?/init.lua;;/usr/local/apisix/?.lua;./?.lua;/usr/local/openresty/luajit/share/luajit-2.1.0-beta3/?.lua;/usr/local/share/lua/5.1/?.lua;/usr/local/share/lua/5.1/?/init.lua;/usr/local/openresty/luajit/share/lua/5.1/?.lua;/usr/local/openresty/luajit/share/lua/5.1/?/init.lua;&#34;;
</span></span><span style=display:flex><span>    lua_package_cpath &#34;$prefix/deps/lib64/lua/5.1/?.so;$prefix/deps/lib/lua/5.1/?.so;;./?.so;/usr/local/lib/lua/5.1/?.so;/usr/local/openresty/luajit/lib/lua/5.1/?.so;/usr/local/lib/lua/5.1/loadall.so;&#34;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    lua_max_pending_timers 16384;
</span></span><span style=display:flex><span>    lua_max_running_timers 4096;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    lua_shared_dict internal-status 10m;
</span></span><span style=display:flex><span>    lua_shared_dict plugin-limit-req 10m;
</span></span><span style=display:flex><span>    lua_shared_dict plugin-limit-count 10m;
</span></span><span style=display:flex><span>    lua_shared_dict prometheus-metrics 10m;
</span></span><span style=display:flex><span>    lua_shared_dict plugin-limit-conn 10m;
</span></span><span style=display:flex><span>    lua_shared_dict upstream-healthcheck 10m;
</span></span><span style=display:flex><span>    lua_shared_dict worker-events 10m;
</span></span><span style=display:flex><span>    lua_shared_dict lrucache-lock 10m;
</span></span><span style=display:flex><span>    lua_shared_dict balancer-ewma 10m;
</span></span><span style=display:flex><span>    lua_shared_dict balancer-ewma-locks 10m;
</span></span><span style=display:flex><span>    lua_shared_dict balancer-ewma-last-touched-at 10m;
</span></span><span style=display:flex><span>    lua_shared_dict plugin-limit-count-redis-cluster-slot-lock 1m;
</span></span><span style=display:flex><span>    lua_shared_dict tracing_buffer 10m; # plugin: skywalking
</span></span><span style=display:flex><span>    lua_shared_dict plugin-api-breaker 10m;
</span></span><span style=display:flex><span>    lua_shared_dict etcd-cluster-health-check 10m; # etcd health check
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    # for openid-connect and authz-keycloak plugin
</span></span><span style=display:flex><span>    lua_shared_dict discovery 1m; # cache for discovery metadata documents
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    # for openid-connect plugin
</span></span><span style=display:flex><span>    lua_shared_dict jwks 1m; # cache for JWKs
</span></span><span style=display:flex><span>    lua_shared_dict introspection 10m; # cache for JWT verification results
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    # for authz-keycloak
</span></span><span style=display:flex><span>    lua_shared_dict access-tokens 1m; # cache for service account access tokens
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    # for ext-plugin
</span></span><span style=display:flex><span>    lua_shared_dict ext-plugin 1m; # cache for ext-plugin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    # for custom shared dict
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    # for proxy cache
</span></span><span style=display:flex><span>    proxy_cache_path /tmp/disk_cache_one levels=1:2 keys_zone=disk_cache_one:50m inactive=1d max_size=1G use_temp_path=off;
</span></span><span style=display:flex><span>    lua_shared_dict memory_cache 50m;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    # for proxy cache
</span></span><span style=display:flex><span>    map $upstream_cache_zone $upstream_cache_zone_info {
</span></span><span style=display:flex><span>        disk_cache_one /tmp/disk_cache_one,1:2;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    lua_ssl_verify_depth 5;
</span></span><span style=display:flex><span>    ssl_session_timeout 86400;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    underscores_in_headers on;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    lua_socket_log_errors off;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    resolver 10.2.255.200 ipv6=on;
</span></span><span style=display:flex><span>    resolver_timeout 5;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    lua_http10_buffering off;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    lua_regex_match_limit 100000;
</span></span><span style=display:flex><span>    lua_regex_cache_max_entries 8192;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    log_format main escape=default &#39;$remote_addr - $remote_user [$time_local] $http_host &#34;$request&#34; $status $body_bytes_sent $request_time &#34;$http_referer&#34; &#34;$http_user_agent&#34; $upstream_addr $upstream_status $upstream_response_time &#34;$upstream_scheme://$upstream_host$upstream_uri&#34;&#39;;
</span></span><span style=display:flex><span>    uninitialized_variable_warn off;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    access_log logs/access.log main buffer=16384 flush=3;
</span></span><span style=display:flex><span>    open_file_cache  max=1000 inactive=60;
</span></span><span style=display:flex><span>    client_max_body_size 0;
</span></span><span style=display:flex><span>    keepalive_timeout 60s;
</span></span><span style=display:flex><span>    client_header_timeout 60s;
</span></span><span style=display:flex><span>    client_body_timeout 60s;
</span></span><span style=display:flex><span>    send_timeout 10s;
</span></span><span style=display:flex><span>    variables_hash_max_size 2048;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    server_tokens off;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    include mime.types;
</span></span><span style=display:flex><span>    charset utf-8;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    # error_page
</span></span><span style=display:flex><span>    error_page 500 @50x.html;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    real_ip_header X-Real-IP;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    real_ip_recursive off;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    set_real_ip_from 127.0.0.1;
</span></span><span style=display:flex><span>    set_real_ip_from unix:;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    # http configuration snippet starts
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    # http configuration snippet ends
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    upstream apisix_backend {
</span></span><span style=display:flex><span>        server 0.0.0.1;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        keepalive 320;
</span></span><span style=display:flex><span>        keepalive_requests 1000;
</span></span><span style=display:flex><span>        keepalive_timeout 60s;
</span></span><span style=display:flex><span>        # we put the static configuration above so that we can override it in the Lua code
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        balancer_by_lua_block {
</span></span><span style=display:flex><span>            apisix.http_balancer_phase()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    apisix_delay_client_max_body_check on;
</span></span><span style=display:flex><span>    apisix_mirror_on_demand on;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    init_by_lua_block {
</span></span><span style=display:flex><span>        require &#34;resty.core&#34;
</span></span><span style=display:flex><span>        apisix = require(&#34;apisix&#34;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        local dns_resolver = { &#34;10.2.255.200&#34;, }
</span></span><span style=display:flex><span>        local args = {
</span></span><span style=display:flex><span>            dns_resolver = dns_resolver,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        apisix.http_init(args)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    init_worker_by_lua_block {
</span></span><span style=display:flex><span>        apisix.http_init_worker()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    exit_worker_by_lua_block {
</span></span><span style=display:flex><span>        apisix.http_exit_worker()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    server {
</span></span><span style=display:flex><span>        listen 127.0.0.1:9090;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        access_log off;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        location / {
</span></span><span style=display:flex><span>            content_by_lua_block {
</span></span><span style=display:flex><span>                apisix.http_control()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        location @50x.html {
</span></span><span style=display:flex><span>            set $from_error_page &#39;true&#39;;
</span></span><span style=display:flex><span>            content_by_lua_block {
</span></span><span style=display:flex><span>                require(&#34;apisix.error_handling&#34;).handle_500()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    server {
</span></span><span style=display:flex><span>        listen 127.0.0.1:9091;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        access_log off;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        location / {
</span></span><span style=display:flex><span>            content_by_lua_block {
</span></span><span style=display:flex><span>                local prometheus = require(&#34;apisix.plugins.prometheus&#34;)
</span></span><span style=display:flex><span>                prometheus.export_metrics()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        location = /apisix/nginx_status {
</span></span><span style=display:flex><span>            allow 127.0.0.0/24;
</span></span><span style=display:flex><span>            deny all;
</span></span><span style=display:flex><span>            stub_status;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    server {
</span></span><span style=display:flex><span>        listen 0.0.0.0:9080 default_server reuseport;
</span></span><span style=display:flex><span>        listen [::]:9080 default_server reuseport;
</span></span><span style=display:flex><span>        listen 0.0.0.0:9443 ssl default_server http2 reuseport;
</span></span><span style=display:flex><span>        listen [::]:9443 ssl default_server http2 reuseport;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        server_name _;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ssl_certificate      cert/ssl_PLACE_HOLDER.crt;
</span></span><span style=display:flex><span>        ssl_certificate_key  cert/ssl_PLACE_HOLDER.key;
</span></span><span style=display:flex><span>        ssl_session_cache    shared:SSL:20m;
</span></span><span style=display:flex><span>        ssl_session_timeout 10m;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ssl_protocols TLSv1.2 TLSv1.3;
</span></span><span style=display:flex><span>        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
</span></span><span style=display:flex><span>        ssl_prefer_server_ciphers on;
</span></span><span style=display:flex><span>        ssl_session_tickets off;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        # http server configuration snippet starts
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        # http server configuration snippet ends
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        location = /apisix/nginx_status {
</span></span><span style=display:flex><span>            allow 127.0.0.0/24;
</span></span><span style=display:flex><span>            deny all;
</span></span><span style=display:flex><span>            access_log off;
</span></span><span style=display:flex><span>            stub_status;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        location /apisix/admin {
</span></span><span style=display:flex><span>            set $upstream_scheme             &#39;http&#39;;
</span></span><span style=display:flex><span>            set $upstream_host               $http_host;
</span></span><span style=display:flex><span>            set $upstream_uri                &#39;&#39;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                allow 127.0.0.0/24;
</span></span><span style=display:flex><span>                deny all;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            content_by_lua_block {
</span></span><span style=display:flex><span>                apisix.http_admin()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        ssl_certificate_by_lua_block {
</span></span><span style=display:flex><span>            apisix.http_ssl_phase()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        proxy_ssl_name $upstream_host;
</span></span><span style=display:flex><span>        proxy_ssl_server_name on;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        location / {
</span></span><span style=display:flex><span>            set $upstream_mirror_host        &#39;&#39;;
</span></span><span style=display:flex><span>            set $upstream_upgrade            &#39;&#39;;
</span></span><span style=display:flex><span>            set $upstream_connection         &#39;&#39;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            set $upstream_scheme             &#39;http&#39;;
</span></span><span style=display:flex><span>            set $upstream_host               $http_host;
</span></span><span style=display:flex><span>            set $upstream_uri                &#39;&#39;;
</span></span><span style=display:flex><span>            set $ctx_ref                     &#39;&#39;;
</span></span><span style=display:flex><span>            set $from_error_page             &#39;&#39;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            # http server location configuration snippet starts
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            # http server location configuration snippet ends
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            access_by_lua_block {
</span></span><span style=display:flex><span>                apisix.http_access_phase()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            proxy_http_version 1.1;
</span></span><span style=display:flex><span>            proxy_set_header   Host              $upstream_host;
</span></span><span style=display:flex><span>            proxy_set_header   Upgrade           $upstream_upgrade;
</span></span><span style=display:flex><span>            proxy_set_header   Connection        $upstream_connection;
</span></span><span style=display:flex><span>            proxy_set_header   X-Real-IP         $remote_addr;
</span></span><span style=display:flex><span>            proxy_pass_header  Date;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            ### the following x-forwarded-* headers is to send to upstream server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            set $var_x_forwarded_for        $remote_addr;
</span></span><span style=display:flex><span>            set $var_x_forwarded_proto      $scheme;
</span></span><span style=display:flex><span>            set $var_x_forwarded_host       $host;
</span></span><span style=display:flex><span>            set $var_x_forwarded_port       $server_port;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            if ($http_x_forwarded_for != &#34;&#34;) {
</span></span><span style=display:flex><span>                set $var_x_forwarded_for &#34;${http_x_forwarded_for}, ${realip_remote_addr}&#34;;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            if ($http_x_forwarded_host != &#34;&#34;) {
</span></span><span style=display:flex><span>                set $var_x_forwarded_host $http_x_forwarded_host;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            if ($http_x_forwarded_port != &#34;&#34;) {
</span></span><span style=display:flex><span>                set $var_x_forwarded_port $http_x_forwarded_port;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            proxy_set_header   X-Forwarded-For      $var_x_forwarded_for;
</span></span><span style=display:flex><span>            proxy_set_header   X-Forwarded-Proto    $var_x_forwarded_proto;
</span></span><span style=display:flex><span>            proxy_set_header   X-Forwarded-Host     $var_x_forwarded_host;
</span></span><span style=display:flex><span>            proxy_set_header   X-Forwarded-Port     $var_x_forwarded_port;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            ###  the following configuration is to cache response content from upstream server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            set $upstream_cache_zone            off;
</span></span><span style=display:flex><span>            set $upstream_cache_key             &#39;&#39;;
</span></span><span style=display:flex><span>            set $upstream_cache_bypass          &#39;&#39;;
</span></span><span style=display:flex><span>            set $upstream_no_cache              &#39;&#39;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            proxy_cache                         $upstream_cache_zone;
</span></span><span style=display:flex><span>            proxy_cache_valid                   any 10s;
</span></span><span style=display:flex><span>            proxy_cache_min_uses                1;
</span></span><span style=display:flex><span>            proxy_cache_methods                 GET HEAD POST;
</span></span><span style=display:flex><span>            proxy_cache_lock_timeout            5s;
</span></span><span style=display:flex><span>            proxy_cache_use_stale               off;
</span></span><span style=display:flex><span>            proxy_cache_key                     $upstream_cache_key;
</span></span><span style=display:flex><span>            proxy_no_cache                      $upstream_no_cache;
</span></span><span style=display:flex><span>            proxy_cache_bypass                  $upstream_cache_bypass;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            proxy_pass      $upstream_scheme://apisix_backend$upstream_uri;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            mirror          /proxy_mirror;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            header_filter_by_lua_block {
</span></span><span style=display:flex><span>                apisix.http_header_filter_phase()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            body_filter_by_lua_block {
</span></span><span style=display:flex><span>                apisix.http_body_filter_phase()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            log_by_lua_block {
</span></span><span style=display:flex><span>                apisix.http_log_phase()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        location @grpc_pass {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            access_by_lua_block {
</span></span><span style=display:flex><span>                apisix.grpc_access_phase()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            grpc_set_header   Content-Type application/grpc;
</span></span><span style=display:flex><span>            grpc_socket_keepalive on;
</span></span><span style=display:flex><span>            grpc_pass         $upstream_scheme://apisix_backend;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            header_filter_by_lua_block {
</span></span><span style=display:flex><span>                apisix.http_header_filter_phase()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            body_filter_by_lua_block {
</span></span><span style=display:flex><span>                apisix.http_body_filter_phase()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            log_by_lua_block {
</span></span><span style=display:flex><span>                apisix.http_log_phase()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        location = /proxy_mirror {
</span></span><span style=display:flex><span>            internal;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            proxy_http_version 1.1;
</span></span><span style=display:flex><span>            proxy_set_header Host $upstream_host;
</span></span><span style=display:flex><span>            proxy_pass $upstream_mirror_host$request_uri;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        location @50x.html {
</span></span><span style=display:flex><span>            set $from_error_page &#39;true&#39;;
</span></span><span style=display:flex><span>            content_by_lua_block {
</span></span><span style=display:flex><span>                require(&#34;apisix.error_handling&#34;).handle_500()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            header_filter_by_lua_block {
</span></span><span style=display:flex><span>                apisix.http_header_filter_phase()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            log_by_lua_block {
</span></span><span style=display:flex><span>                apisix.http_log_phase()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    # http end configuration snippet starts
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    # http end configuration snippet ends
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol><li><p>根据模板生成的<code>nginx.conf</code>监听的<code>9080</code>和<code>9443</code>端口，IP则是<code>0.0.0.0</code>和<code>[::]</code>这是特殊IP，允许所有IP的请求进入</p></li><li><p><code>/apisix/admin</code>的location主要是处理控制面的接口。</p></li><li><p>在OpenResty的<code>init</code>阶段嵌入<code>apisix.http_init(args)</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>init_by_lua_block {
</span></span><span style=display:flex><span>     require &#34;resty.core&#34;
</span></span><span style=display:flex><span>     apisix = require(&#34;apisix&#34;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     local dns_resolver = { &#34;10.2.255.200&#34;, }
</span></span><span style=display:flex><span>     local args = {
</span></span><span style=display:flex><span>         dns_resolver = dns_resolver,
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>     apisix.http_init(args)
</span></span><span style=display:flex><span> }
</span></span></code></pre></div></li><li><p>在<code>init_worker</code>阶段嵌入<code>apisix.http_init_worker()</code></p></li><li><p>在<code>exit_worker</code>阶段嵌入<code>apisix.http_exit_worker()</code></p></li><li><p>在<code>ssl_handshake</code>阶段嵌入<code>apisix.http_ssl_phase()</code></p></li><li><p>在<code>access</code>阶段嵌入<code>apisix.http_access_phase()</code>，apisix没有设置<code>rewrite</code>阶段，匹配路由，挑选server</p></li><li><p>在<code>content</code>阶段，设置上游server，apisix主要通过<code>apisix.http_balancer_phase()</code>实现的。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>upstream apisix_backend {
</span></span><span style=display:flex><span>     server 0.0.0.1;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     keepalive 320;
</span></span><span style=display:flex><span>     keepalive_requests 1000;
</span></span><span style=display:flex><span>     keepalive_timeout 60s;
</span></span><span style=display:flex><span>     # we put the static configuration above so that we can override it in the Lua code
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     balancer_by_lua_block {
</span></span><span style=display:flex><span>         apisix.http_balancer_phase()
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span> }
</span></span></code></pre></div></li><li><p>在<code>header_filter</code>阶段嵌入<code>apisix.http_header_filter_phase()</code></p></li><li><p>在<code>body_filter</code>阶段嵌入<code>apisix.http_body_filter_phase()</code></p></li><li><p>在<code>log</code>阶段嵌入<code>apisix.http_log_phase()</code></p></li></ol><p>到这里apisix启动流程介绍完了，启动过程主要是初始化数据以及etcd，生成<code>nginx.conf</code>配置，apisix大部分的代码逻辑都嵌入到OpenResty处理请求的各个阶段，
后面再分析一个请求在apisix的处理过程、etcd数据同步过程和apisix的控制面。</p><h2 id=引用>引用</h2><ol><li><a href=https://shoujo.ink/2021/09/apisix-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ target=_blank rel=noopener>APISIX源码分析</a></li></ol></div><footer class=post-footer><div class=post-tags><a href=/tags/apisix rel=tag title=apisix>#apisix#</a>
<a href=/tags/nginx rel=tag title=nginx>#nginx#</a></div><div class=addthis_inline_share_toolbox></div><div class=post-nav><div class=article-copyright><div class=article-copyright-img><img src=/img/qq_qrcode.png width=129px height=129px><div style=text-align:center>QQ扫一扫交流</div></div><div class=article-copyright-info><p><span>标题：</span>APISIX源码-启动过程</p><p><span>链接：</span>/post/apisix-start/</p><p><span>作者：</span>lizj3624</p><p><span>声明： </span>本博客文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/3.0/ target=_blank style=text-decoration:underline>CC BY-NC-SA 3.0</a>许可协议，转载请注明出处！</p></div></div><div class=clear></div></div><div class=reward-qr-info><div>创作实属不易，如有帮助，那就打赏博主些许茶钱吧 ^_^</div><button id=rewardButton disable=enable onclick='var qr=document.getElementById("QR");qr.style.display==="none"?qr.style.display="block":qr.style.display="none"'>
<span>赏</span></button><div id=QR style=display:none><div id=wechat style=display:inline-block><img id=wechat_qr src=/img/wechat-pay.png alt="WeChat Pay"><p>微信打赏</p></div><div id=alipay style=display:inline-block><img id=alipay_qr src=/img/ali-pay.png alt=Alipay><p>支付宝打赏</p></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/fisher-common-stocks-and-uncommon-profits-reading/ rel=next title=怎样选择成长股-费雪读书笔记><i class="fa fa-chevron-left"></i> 怎样选择成长股-费雪读书笔记</a></div><div class="post-nav-prev post-nav-item"><a href=/post/tencent-2021q4-fy/ rel=prev title=腾讯2021Q4以及全年财报>腾讯2021Q4以及全年财报
<i class="fa fa-chevron-right"></i></a></div></div><div id=wcomments></div></footer></article></section></div></div><div class=sidebar-toggle><div class=sidebar-toggle-line-wrap><span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
<span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id=sidebar class=sidebar><div class=sidebar-inner><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target=post-toc-wrap>文章目录</li><li class=sidebar-nav-overview data-target=site-overview>站点概览</li></ul><section class="site-overview sidebar-panel"><div class="site-author motion-element" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image src=/img/avatar.png alt=lizj3624><p class=site-author-name itemprop=name>lizj3624</p><p class="site-description motion-element" itemprop=description>幸福和富有的过一生!</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href=/post/><span class=site-state-item-count>92</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>89</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>106</span>
<span class=site-state-item-name>标签</span></a></div></nav><div class="links-of-author motion-element"><span class=links-of-author-item><a href=https://github.com/lizj3624/ target=_blank title=GitHub><i class="fa fa-fw fa-github"></i>
GitHub</a></span>
<span class=links-of-author-item><a href=https://www.zhihu.com/people/li-zun-ju target=_blank title=知乎><i class="fa fa-fw fa-globe"></i>
知乎</a></span></div><div class="tagcloud-of-blogroll motion-element tagcloud-of-blogroll-inline"><div class=tagcloud-of-blogroll-title><i class="fa fa-fw fa-tags"></i>
标签云</div><ul class=tagcloud-of-blogroll-list><li class=tagcloud-of-blogroll-item><a href=/tags/cloudnative>Cloudnative
<sup>13</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E8%B4%A2%E6%8A%A5>财报
<sup>11</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/kubernetes>Kubernetes
<sup>10</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/nginx>Nginx
<sup>9</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/apisix>Apisix
<sup>7</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E7%BE%8E%E8%82%A1>美股
<sup>6</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/video>Video
<sup>5</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E5%AE%8F%E8%A7%82%E7%BB%8F%E6%B5%8E>宏观经济
<sup>5</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/%E6%8A%95%E8%B5%84>投资
<sup>5</sup></a></li><li class=tagcloud-of-blogroll-item><a href=/tags/linux>Linux
<sup>4</sup></a></li></ul></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class=post-toc><div class=post-toc-content><nav id=TableOfContents><ul><li><a href=#apisix启动命令>apisix启动命令</a></li><li><a href=#启动源码简析>启动源码简析</a><ul><li><a href=#启动流程>启动流程</a></li><li><a href=#源码分析>源码分析</a></li></ul></li><li><a href=#引用>引用</a></li></ul></nav></div></div></section></div></aside></div></main><footer id=footer class=footer><div class=footer-inner><div class=copyright><span class=copyright-year>&copy; 2010 - 2024</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=copyright-author>幸福和富有的过一生</span></div><div class=powered-info><span class=powered-by>Powered by - <a class=powered-link href=//gohugo.io target=_blank title=hugo>Hugo v0.119.0</a></span>
<span class=separator-line>/</span>
<span class=theme-info>Theme by - <a class=powered-link href=//github.com/elkan1788/hugo-theme-next target=_blank>NexT</a></span></div><div class=vistor-info><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<span class=site-uv><i class="fa fa-user"></i>
<span class=busuanzi-value id=busuanzi_value_site_uv></span></span>
<span class=separator-line>/</span>
<span class=site-pv><i class="fa fa-eye"></i>
<span class=busuanzi-value id=busuanzi_value_site_pv></span></span></div><div class=license-info><span class=storage-info>Storage by
<a href style=font-weight:700 target=_blank></a></span>
<span class=separator-line>/</span>
<span class=license-num><a href target=_blank></a></span></div></div></footer><div class=back-to-top><i class="fa fa-arrow-up"></i>
<span id=scrollpercent><span>0</span>%</span></div></div><script type=text/javascript src=//unpkg.com/jquery@2.1.4/dist/jquery.min.js></script>
<script type=text/javascript src=/js/search.js></script>
<script type=text/javascript src=/js/affix.js></script>
<script type=text/javascript>function detectIE(){var e=window.navigator.userAgent,t=e.indexOf("MSIE "),n=e.indexOf("Trident/"),s=e.indexOf("Edge/");return t>0||n>0||s>0?-1:1}function getCntViewHeight(){var t=$("#content").height(),e=$(window).height(),n=t>e?t-e:$(document).height()-e;return n}function getScrollbarWidth(){var e=$("<div />").addClass("scrollbar-measure").prependTo("body"),t=e[0],n=t.offsetWidth-t.clientWidth;return e.remove(),n}function registerBackTop(){var t=50,e=$(".back-to-top");$(window).on("scroll",function(){e.toggleClass("back-to-top-on",window.pageYOffset>t);var s=$(window).scrollTop(),o=getCntViewHeight(),i=s/o,n=Math.round(i*100),a=n>100?100:n;$("#scrollpercent>span").html(a)}),e.on("click",function(){$("html,body").animate({scrollTop:0,screenLeft:0},800)})}function initScrollSpy(){var e=".post-toc",s=$(e),t=".active-current";s.on("activate.bs.scrollspy",function(){var t=$(e+" .active").last();n(),t.addClass("active-current")}).on("clear.bs.scrollspy",n),$("body").scrollspy({target:e});function n(){$(e+" "+t).removeClass(t.substring(1))}}function initAffix(){var e=$(".header-inner").height(),t=parseInt($(".footer").outerHeight(!0),10),n=e+10;$(".sidebar-inner").affix({offset:{top:n,bottom:t}})}function initTOCDimension(){$(window).on("resize",function(){e&&clearTimeout(e),e=setTimeout(function(){var e=document.body.clientHeight-100;updateTOCHeight(e)},0)}),updateTOCHeight(document.body.clientHeight-100);var e,t=getScrollbarWidth();$(".post-toc").css("width","calc(100% + "+t+"px)")}function updateTOCHeight(e){e=e||"auto",$(".post-toc").css("max-height",e)}$(function(){var e,t,n,s,o=$(".header-inner").height()+10;$("#sidebar").css({"margin-top":o}).show(),t=parseInt($("#sidebar").css("margin-top")),n=parseInt($(".sidebar-inner").css("height")),e=t+n,s=$(".content-wrap").height(),s<e&&$(".content-wrap").css("min-height",e),$(".site-nav-toggle").on("click",function(){var e=$(".site-nav"),o=$(".toggle"),t="site-nav-on",i="toggle-close",n=e.hasClass(t),a=n?"slideUp":"slideDown",s=n?"removeClass":"addClass";e.stop()[a]("normal",function(){e[s](t),o[s](i)})}),registerBackTop(),initAffix(),initTOCDimension(),$(".sidebar-nav-toc").click(function(){$(this).addClass("sidebar-nav-active"),$(this).next().removeClass("sidebar-nav-active"),$("."+$(this).next().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)}),$(".sidebar-nav-overview").click(function(){$(this).addClass("sidebar-nav-active"),$(this).prev().removeClass("sidebar-nav-active"),$("."+$(this).prev().attr("data-target")).toggle(500),$("."+$(this).attr("data-target")).toggle(500)})})</script><script src=//unpkg.com/imageviewer@1.1.0/dist/viewer.min.js></script>
<script type=text/javascript>$(function(){$(".post-body").viewer()})</script><script type=text/javascript>const locale={placeholder:"欢迎留下您的宝贵建议，请填写您的昵称和邮箱便于后续交流. ^_^"};$(function(){detectIE()>0?$.getScript(document.location.protocol+"//unpkg.com/@waline/client@1.6.0/dist/Waline.min.js",function(){new Waline({el:"#wcomments",visitor:!0,emoji:[],wordLimit:"200",uploadImage:!1,locale,requiredMeta:["nick","mail"],serverURL:"lizj3624-comment.vercel.app",lang:"zh-cn"})}):$("#wcomments").html("抱歉，Waline插件不支持IE或Edge，建议使用Chrome浏览器。")})</script><script type=text/javascript src="//s7.addthis.com/js/300/addthis_widget.js#pubid=Your%20AddthisId"></script>
<script>(function(){var t,e=document.createElement("script"),n=window.location.protocol.split(":")[0];n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></body></html>